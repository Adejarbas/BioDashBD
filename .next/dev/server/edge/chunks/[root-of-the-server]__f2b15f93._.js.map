{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport type { NextRequest } from \"next/server\";\r\nimport { createServerClient } from \"@supabase/ssr\";\r\n\r\n// Remove barra final se existir na origem\r\nfunction normalizeOrigin(origin: string) {\r\n  return origin.endsWith(\"/\") ? origin.slice(0, -1) : origin;\r\n}\r\n\r\n// Permitir múltiplas origens (dev e produção)\r\nconst ALLOWED_ORIGINS = [\r\n  normalizeOrigin(process.env.FRONTEND_URL || \"http://localhost:3001\"),\r\n  normalizeOrigin(process.env.NEXT_PUBLIC_FRONTEND_URL || \"http://localhost:3001\"),\r\n].filter((origin, index, self) => self.indexOf(origin) === index); // Remove duplicatas\r\n\r\nfunction isAllowedOrigin(origin: string | null): boolean {\r\n  if (!origin) return false;\r\n  const normalized = normalizeOrigin(origin);\r\n  return ALLOWED_ORIGINS.some(allowed => allowed === normalized);\r\n}\r\n\r\nexport async function middleware(req: NextRequest) {\r\n  // Preflight CORS para /api\r\n\r\n  // CORS Preflight para /api\r\n  if (req.method === \"OPTIONS\" && req.nextUrl.pathname.startsWith(\"/api\")) {\r\n    const origin = req.headers.get(\"origin\");\r\n    const resPre = new NextResponse(null, { status: 204 });\r\n    \r\n    if (origin && isAllowedOrigin(origin)) {\r\n      const normalizedOrigin = normalizeOrigin(origin);\r\n      resPre.headers.set(\"Access-Control-Allow-Origin\", normalizedOrigin);\r\n      resPre.headers.set(\"Access-Control-Allow-Methods\", \"GET,POST,PUT,DELETE,OPTIONS\");\r\n      resPre.headers.set(\"Access-Control-Allow-Headers\", \"Content-Type, Authorization, Cookie\");\r\n      resPre.headers.set(\"Access-Control-Allow-Credentials\", \"true\");\r\n      resPre.headers.set(\"Vary\", \"Origin\");\r\n    }\r\n    \r\n    return resPre;\r\n  }\r\n\r\n  const res = NextResponse.next();\r\n\r\n  // CORS em rotas /api\r\n  if (req.nextUrl.pathname.startsWith(\"/api\")) {\r\n    const origin = req.headers.get(\"origin\");\r\n    \r\n    if (origin && isAllowedOrigin(origin)) {\r\n      const normalizedOrigin = normalizeOrigin(origin);\r\n      res.headers.set(\"Access-Control-Allow-Origin\", normalizedOrigin);\r\n      res.headers.set(\"Access-Control-Allow-Credentials\", \"true\");\r\n      res.headers.set(\"Vary\", \"Origin\");\r\n    }\r\n  }\r\n\r\n  if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {\r\n    return res;\r\n  }\r\n\r\n  // Proteção /dashboard\r\n  if (req.nextUrl.pathname.startsWith(\"/dashboard\")) {\r\n    try {\r\n      const supabase = createServerClient(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n        {\r\n          cookies: {\r\n            getAll: () => req.cookies.getAll(),\r\n            setAll: (cookiesToSet) => {\r\n              cookiesToSet.forEach(({ name, value, options }) =>\r\n                res.cookies.set(name, value, { ...(options || {}), path: \"/\" })\r\n              );\r\n            },\r\n          },\r\n        }\r\n      );\r\n      const { data } = await supabase.auth.getUser();\r\n      if (!(data as any)?.user) {\r\n        const loginUrl = new URL(\"/login\", req.url);\r\n        loginUrl.searchParams.set(\"next\", req.nextUrl.pathname + (req.nextUrl.search || \"\"));\r\n        return NextResponse.redirect(loginUrl);\r\n      }\r\n    } catch {\r\n      // fail-open\r\n    }\r\n  }\r\n\r\n  return res;\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\"/dashboard/:path*\", \"/api/:path*\"],\r\n};"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAEA;AAAA;;;AAEA,0CAA0C;AAC1C,SAAS,gBAAgB,MAAc;IACrC,OAAO,OAAO,QAAQ,CAAC,OAAO,OAAO,KAAK,CAAC,GAAG,CAAC,KAAK;AACtD;AAEA,8CAA8C;AAC9C,MAAM,kBAAkB;IACtB,gBAAgB,QAAQ,GAAG,CAAC,YAAY,IAAI;IAC5C,gBAAgB,6DAAwC;CACzD,CAAC,MAAM,CAAC,CAAC,QAAQ,OAAO,OAAS,KAAK,OAAO,CAAC,YAAY,QAAQ,oBAAoB;AAEvF,SAAS,gBAAgB,MAAqB;IAC5C,IAAI,CAAC,QAAQ,OAAO;IACpB,MAAM,aAAa,gBAAgB;IACnC,OAAO,gBAAgB,IAAI,CAAC,CAAA,UAAW,YAAY;AACrD;AAEO,eAAe,WAAW,GAAgB;IAC/C,2BAA2B;IAE3B,2BAA2B;IAC3B,IAAI,IAAI,MAAM,KAAK,aAAa,IAAI,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,SAAS;QACvE,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC;QAC/B,MAAM,SAAS,IAAI,gMAAY,CAAC,MAAM;YAAE,QAAQ;QAAI;QAEpD,IAAI,UAAU,gBAAgB,SAAS;YACrC,MAAM,mBAAmB,gBAAgB;YACzC,OAAO,OAAO,CAAC,GAAG,CAAC,+BAA+B;YAClD,OAAO,OAAO,CAAC,GAAG,CAAC,gCAAgC;YACnD,OAAO,OAAO,CAAC,GAAG,CAAC,gCAAgC;YACnD,OAAO,OAAO,CAAC,GAAG,CAAC,oCAAoC;YACvD,OAAO,OAAO,CAAC,GAAG,CAAC,QAAQ;QAC7B;QAEA,OAAO;IACT;IAEA,MAAM,MAAM,gMAAY,CAAC,IAAI;IAE7B,qBAAqB;IACrB,IAAI,IAAI,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,SAAS;QAC3C,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC;QAE/B,IAAI,UAAU,gBAAgB,SAAS;YACrC,MAAM,mBAAmB,gBAAgB;YACzC,IAAI,OAAO,CAAC,GAAG,CAAC,+BAA+B;YAC/C,IAAI,OAAO,CAAC,GAAG,CAAC,oCAAoC;YACpD,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ;QAC1B;IACF;IAEA;;IAIA,sBAAsB;IACtB,IAAI,IAAI,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,eAAe;QACjD,IAAI;YACF,MAAM,WAAW,IAAA,uMAAkB,sUAGjC;gBACE,SAAS;oBACP,QAAQ,IAAM,IAAI,OAAO,CAAC,MAAM;oBAChC,QAAQ,CAAC;wBACP,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,IAAI,OAAO,CAAC,GAAG,CAAC,MAAM,OAAO;gCAAE,GAAI,WAAW,CAAC,CAAC;gCAAG,MAAM;4BAAI;oBAEjE;gBACF;YACF;YAEF,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;YAC5C,IAAI,CAAE,MAAc,MAAM;gBACxB,MAAM,WAAW,IAAI,IAAI,UAAU,IAAI,GAAG;gBAC1C,SAAS,YAAY,CAAC,GAAG,CAAC,QAAQ,IAAI,OAAO,CAAC,QAAQ,GAAG,CAAC,IAAI,OAAO,CAAC,MAAM,IAAI,EAAE;gBAClF,OAAO,gMAAY,CAAC,QAAQ,CAAC;YAC/B;QACF,EAAE,OAAM;QACN,YAAY;QACd;IACF;IAEA,OAAO;AACT;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;QAAqB;KAAc;AAC/C"}}]
}